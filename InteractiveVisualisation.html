<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
    svg {
        width: 600;
        height: 500;
    }

    </style>
</head>

<body>
<svg width = "600" height = "500"></svg>

<form id = "sub">
    <input type="radio" name="subject" value="Test-takers">Test-takers</input>
    <input type="radio" name="subject" value="Math">Math</input>
    <input type="radio" name="subject" value="Verbal">Verbal</input>
</form>

<div>
    <button type="button" value='Family Income.Less than 20k.'>Below 20k</button>
    <button type="button" value='Family Income.Between 20-40k.'>20k - 40k</button>
    <button type="button" value='Family Income.Between 40-60k.'>40k - 60k</button>
    <button type="button" value='Family Income.Between 60-80k.'>60k - 80k</button>
    <button type="button" value='Family Income.Between 80-100k.'>80k - 100k</button>
    <button type="button" value='Family Income.More than 100k.'>Above 100k</button> 
</div>
</body>

<script src="http://d3js.org/d3.v6.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<script>

//do scales
var svg = d3.select("svg");
var margin = 200;
var width = svg.attr("width") - margin;
var height = svg.attr("height") - margin;

//make scales (doesn't have the tick yet though)
var xScale = d3.scaleBand().range([0, width]).padding(0.4),
    yScale = d3.scaleLinear().range([height, 0]);

//idk why but yeh
var g = svg.append("g")
            .attr("transform", "translate(" + 100 + "," + 100 + ")");

// lists
var stateNames = ["Alaska", "Alabama", "Arkansas", "American Samoa", "Arizona", "California", "Colorado", "Connecticut", "District of Columbia", "Delaware", "Florida", "Georgia", "Guam", "Hawaii", "Iowa", "Idaho", "Illinois", "Indiana", "Kansas", "Kentucky", "Louisiana", "Massachusetts", "Maryland", "Maine", "Michigan", "Minnesota", "Missouri", "Mississippi", "Montana", "North Carolina", "North Dakota", "Nebraska", "New Hampshire", "New Jersey", "New Mexico", "Nevada", "New York", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Puerto Rico", "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Virginia", "Virgin Islands", "Vermont", "Washington", "Wisconsin", "West Virginia", "Wyoming"]; 
var years = ["2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015"];
var incomes = ['Family Income.Less than 20k.Test-takers', 'Family Income.Between 20-40k.Test-takers', 'Family Income.Between 40-60k.Test-takers', 'Family Income.Between 60-80k.Test-takers', 'Family Income.Between 80-100k.Test-takers', 'Family Income.More than 100k.Test-takers'];

//color scale
var myColor = d3.scaleOrdinal()
      .domain(incomes)
      .range(d3.schemeSet2);

//get data
d3.csv("school_scores.csv").then(function(data) {
    function generateMedians(chosenCol){
        var yearMedians = []
        for (i = 0; i < years.length; i++){
            yearMedians[i] = d3.median(data.filter(d => d.Year === years[i]), d => d[chosenCol]);
        }

        //make final data array with year and median columns
        var medianData = []; // start empty, add each element one at a time
        for(var i = 0; i < years.length; i++ ) {
            medianData.push({year: years[i], median: yearMedians[i]});
        }

        return medianData;
    }
    
    var medianData = generateMedians(incomes[0]); 
    
    //create axes
    xScale.domain(d3.map(data, function(d) { return d.Year; }));
    yScale.domain([0, 1600]); 
    
    //x axis
    g.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(xScale))
    .append("text")
    .attr("y", height - 250)
    .attr("x", width - 100)
    .attr("text-anchor", "end")
    .attr("stroke", "black")
    .text("Year");

    //y axis
    g.append("g")
    .call(d3.axisLeft(yScale))
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", 6)
    .attr("dy", "-5.1em")
    .attr("text-anchor", "end")
    .attr("stroke", "black")
    .text("AVG Number of Testtakers");

    //make default line
    g.append("path")
    .datum(medianData)
    .attr("class", "line")
    .attr("id", "Family Income.Less than 20k.Test-takers")
    .attr("fill", "none")
    .attr("stroke", function(d) { return myColor('Family Income.Less than 20k.Test-takers')})
    .attr("stroke-width", 1.5)
    .attr("d", d3.line()
        .x(function(d) { return xScale(d.year) })
        .y(function(d) { return yScale(d.median) }));

    //update the graph
    function chooseFamilyIncomeBracket(chosenIncome){
        //console.log("we're in bois.")
        //console.log(years)
        //make new median
        console.log(chosenIncome)
        var medians = []
        for (i = 0; i < years.length; i++){
            medians[i] = d3.median(data.filter(d => d.Year === years[i]), d => d[chosenIncome]);
        }

        var updateData = [];
        for(var i = 0; i < years.length; i++ ) {
            updateData.push({year: years[i], median: medians[i]});
        } 

        g.append("path").
            datum(updateData)
            .attr("d", d3.line()
                .x(function(d) { return xScale(d.year) })
                .y(function(d) { return yScale(d.median) }))
            .attr("stroke", "red")
            .attr("fill", "none")
            .attr("class", "line")
            .attr("stroke-width", 1.5);

        console.log(data);
        //console.log(updateData);
    }

    var subjectVal;
    var inputs=document.getElementsByTagName("input"),
        x=inputs.length;
    while(x--)
        if(inputs[x].type==="radio")
            inputs[x].addEventListener("change",function(){
                subjectVal = this.value
                if (subjectVal != '') {
                    //add on click for the update function
                    d3.selectAll("button")
                        .on("click", function(d){
                            var button = d3.select(this)
                            var value = button.property('value')
                            var active = button.attr('class')
                            console.log(active)

                            value = value + subjectVal

                            if (active === 'active') {
                                button.attr('class', 'null');
                                button.attr('style', 'null');
                                d3.select('#'+value).remove();
                            }
                            else {
                                button.attr('class', 'active');
                                button.attr('style', 'background-color:'+myColor(value))
                                chooseFamilyIncomeBracket(value);
                            }
                        })
                }

            },0);
            
    //add on click for the update function
    // d3.selectAll("button")
    //                     .on("click", function(d){
    //                         var value = d3.select(this).property('value')
    //                         // value.concat(subjectVal)
    //                         value = value + subjectVal
    //                         chooseFamilyIncomeBracket(value)
    //                     })
})       
</script>
</html>